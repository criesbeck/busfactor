<!DOCTYPE html>
<html>
  <head>
    <title>Bus Factors</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="./app.css" rel="stylesheet">
  </head>
  <body>
    <div class="container" id="app">
      <div class="upload-box">
        <div class="mb-3">
          <label for="logGile" class="form-label">Gitlog File</label>
          <input class="form-control" type="file" id="logFile" @change="loadFile">
        </div>
        <div v-if="data.files.length === 0">
          <p>
            Upload the output of <code>git log --no-merges --name-status</code>, 
            e.g., upload <code>/tmp/gitlog.txt</code> if you did
          </p>
          <pre><code>git log --no-merges --name-status > /tmp/gitlog.txt</code></pre>
        </div>
      </div>
      <hr>
      <table class="table" v-if="data.files.length > 0">
        <thead>
          <th>File</th>
          <th v-for="author in data.authors">{{author}}</th>
        </thead>
        <tbody>
          <tr v-for="entry in data.files">
            <td :class="{ risky: entry.contributors < 3 }">
              <small>{{pathPart(entry.file)}}</small>
              <div>{{filePart(entry.file)}}</div>
              <small>
                Edits: {{entryEdits(entry)}}<br>
                {{entryLastEdit(entry)}}
              </small>
            </td>
            <td v-for="author in data.authors" :class="{ risky: authorContribution(entry, author) < 3 }">
              <div>{{authorContribution(entry, author)}}%</div>
              <small>Edits: {{entry.authors[author].edits.length}}</small>
              <small> {{shortDate(entry.authors[author].edits[0])}}</small>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <script src="https://unpkg.com/vue@3"></script>
    <script src="./app.js"></script>
    <script type="text/javascript">
      const app = Vue.createApp({
        data() {
          return {
            log: '...loading',
            data: {
              files: [],
              authors: []
            }
          }
        },
        methods: {
          loadFile(evt) {
            loadFile(evt.target.files[0], (text) => {
              this.log = text;
              this.data = getData(text);
              evt.target.blur();
            })
          },
          pathPart(filename) {
            const n = filename.lastIndexOf('/');
            return n === -1 ? '' : filename.slice(0, n + 1);
          },
          filePart(filename) {
            const n = filename.lastIndexOf('/');
            return n === -1 ? filename : filename.slice(n + 1);
          },
          shortDate(date) {
            return date ? new Date(date).toLocaleDateString() : '--'
          },
          entryEdits(entry) {
            return Object.values(entry.authors).reduce((sum, author) => sum + author.edits.length, 0);
          },
          entryLastEdit(entry) {
            const val = (date) => date ? Date.parse(date) : 0;
            return this.shortDate(Object.values(entry.authors).map(x => x.edits[0]).sort((date1, date2) => (
              val(date2) - val(date1)
            ))[0]);
          },
          authorEdits(file, author) {
            return this.data.history[file].authors[author].edits.length;
          },
          authorLastEdit(file, author) {
            return this.shortDate(this.data.history[file].authors[author].edits[0]);
          },
          authorContribution(entry, author) {
            return Math.ceil(entry.authors[author].frecency/entry.frecency*100);
          }
        }
      })
      
      app.mount('#app');
    </script>
  </body>
</html>
